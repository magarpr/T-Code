version: "1.0"

commands:
    - name: Fetch and checkout PR branch
      run: |
        # Try to get PR info from various possible environment variables
        if [ -n "$GITHUB_HEAD_REF" ]; then
          echo "Checking out PR branch: $GITHUB_HEAD_REF"
          git fetch origin "$GITHUB_HEAD_REF"
          git checkout -B "$GITHUB_HEAD_REF" "origin/$GITHUB_HEAD_REF"
        elif [ -n "$GITHUB_REF" ] && [[ "$GITHUB_REF" =~ ^refs/pull/([0-9]+)/ ]]; then
          PR_NUMBER="${BASH_REMATCH[1]}"
          echo "Fetching PR #$PR_NUMBER"
          git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
          git checkout "pr-$PR_NUMBER"
        elif [ -n "$GITHUB_EVENT_PATH" ] && [ -f "$GITHUB_EVENT_PATH" ]; then
          # Try to extract PR number from GitHub event JSON
          PR_NUMBER=$(jq -r '.pull_request.number // .number // empty' "$GITHUB_EVENT_PATH" 2>/dev/null)
          if [ -n "$PR_NUMBER" ]; then
            echo "Fetching PR #$PR_NUMBER from event data"
            git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
            git checkout "pr-$PR_NUMBER"
          else
            echo "Could not determine PR number from event data"
          fi
        else
          echo "No PR information found in environment, using current branch"
        fi
      timeout: 60
      execution_phase: task_run
    - name: Install dependencies
      run: pnpm install
      timeout: 60
      execution_phase: task_run

github_events:
    - event: issues.opened
      action:
          name: github.issue.fix
    - event: issue_comment.created
      action:
          name: github.issue.comment.respond
    - event: pull_request.opened
      action:
          name: github.pr.review
    - event: pull_request.opened
      action:
          name: general.task
          prompt: |
              1. Run the script `node scripts/find-missing-translations.js` and carefully review its output for any missing translations.
              2. If the script reports missing translations, switch into `translate` mode and add them in all supported languages.
              3. If you've added new translations, commit and push them to the existing PR.
              4. If you get a permission error trying to push to the PR just give up (i.e don't create a new PR instead).
    - event: pull_request_review_comment.created
      action:
          name: github.pr.comment.respond
